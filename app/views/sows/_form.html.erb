<%= form_for([@contract, @sow]) do |f| %>
  <% if @sow.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@sow.errors.count, "error") %> prohibited this sow from being saved:</h2>

      <ul>
      <% @sow.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>
 
  <div class="field">
    <%= f.label :product, "Product Name",:id=>"productname" %><br />
    <% ary = Array.new() %>
    <% @contract.sows.each do |asow| %>
      <% ary << asow.product_id %>
    <% end %>
    <%= collection_select(:sow, :product_id, Product.find_all_not_in(ary), :id, :formal_name, {:prompt => 'Please select the product'}, {:class=>'productselect'}) %>
  </div>

  <div class="autopart">
  <%= render :partial=>"autointel",:locals=>{:f=>f,:sow=>@sow} %>
  </div>

  <%= f.fields_for :sow_files do |fi| %>

      <div id="file" >
        <br /><br /><br />
        <p><%= fi.file_field :file %></p>
        <p><%= fi.hidden_field :file_cache %></p><br /><br /><br />
      </div>


   <% end %><br />

  <br><br><br> 
  <div class="actions" id = "submitbutton">
    <%= f.submit %>
  </div>
<% end %>


<script>
$('#productname').tooltip({'trigger':'click hover focus', 'title': 'Please select the product name' });
  $('#casend').tooltip({'trigger':'click hover focus', 'title': 'The date on which we send credit agreement to the client' });
  $('#ca').tooltip({'trigger':'click hover focus', 'title': 'Please check this checkbox if you need sign credit agreement' });
  $('#casigndate').tooltip({'trigger':'click hover focus', 'title': 'The date on which we sign credit agreement' });

  function reset_alllevel() {
    $("#type").hide();
    $("#subtype").hide();
    $("#contingencyperpayor").hide();
    $("#contingencyglobal").hide();
    $("#perhitperpayor").hide();
    $("#perhitglobal").hide();
    $("#score_payment").hide();
    $("#score_charity").hide();
    $("#term").hide();
    $("#file").hide();
    $("#ca_part").hide();
    $("#submitbutton").hide();
    $("#autointel").hide();
  }


  function reset_sublevel() {
    $("#contingencyperpayor").hide();
    $("#contingencyglobal").hide();
    $("#perhitperpayor").hide();
    $("#perhitglobal").hide();
    $("#score").hide();
    $("#term").hide();
    $("#autointel").hide();
  }

  $(function(){
    $("#cadate").hide();

    $("#addstate").click(function(){
      var stateID = $("#autointelstate div").length ;
      var fieldWrapper = $("<div class=\"fieldwrapper \" id=\"field" + stateID + "\"/>");
      var fName;
      var fVersion = $("<input type=\"text\" id=\"sow_autointel_rates_attributes_"+ stateID +"_version\" name=\"sow[autointel_rates_attributes]["+ stateID +"][version]\" class=\"fieldname\" value=\"<%= @sow.version + 1 %>\"   style=\"display: none;\"/>" ); 

      var fMainType = $("<input type=\"text\" id=\"sow_autointel_rates_attributes_0_maintype\" name=\"sow[autointel_rates_attributes]["+ stateID +"][maintype]\" class=\"fieldname\" value=\"" + $("#type option:selected").text() + "\" style=\"display: none;\"/>" ); 
      
      if ($("#type option:selected").text().toLowerCase() == "per hit") {
          fName = $("<input type=\"text\" id=\"sow_autointel_rates_attributes_"+ stateID +"_rate\" name=\"sow[autointel_rates_attributes]["+ stateID +"][rate]\" class=\"fieldname\"   style=\"float:left;margin-right:10px; position: relative;\"/><label style=\"text-align: left;\">$</label>" ); 
      } else {
          fName = $("<input type=\"text\" id=\"sow_autointel_rates_attributes_"+ stateID +"_state_rate\" name=\"sow[autointel_rates_attributes]["+ stateID +"][rate]\" class=\"fieldname\" value=\"%\" style=\"float:left;margin-right:10px; position: relative;\"/>"); 
      }

      var fType = $("<select class=\"fieldtype\" id=\"sow_autointel_rates_attributes_"+ stateID +"_state\" name=\"sow[autointel_rates_attributes]["+ stateID +"][state]\" style=\"float:left;margin-right:10px; position: relative;\"> <option value=\"AK\">Alaska</option><option value=\"AZ\">Arizona</option><option value=\"AR\">Arkansas</option><option value=\"CA\">California</option><option value=\"CO\">Colorado</option><option value=\"CT\">Connecticut</option><option value=\"DE\">Delawar</option><option value=\"FL\">Florida</option><option value=\"GA\">Georgia</option><option value=\"HI\">Hawaii</option><option value=\"ID\">Idah</option><option value=\"IL\">Illinois</option><option value=\"IN\">Indiana</option><option value=\"IA\">Iowa</option><option value=\"KS\">Kansas</option><option value=\"KY\">Kentucky</option><option value=\"LA\">Louisiana</option><option value=\"ME\">Maine</option><option value=\"MD\">Maryland </option><option value=\"MA\">Massachusetts</option><option value=\"MI\">Michigan</option><option value=\"MN\">Minnesota</option><option value=\"MS\">Mississippi</option><option value=\"MO\">Missouri</option><option value=\"MT\">Montan</option><option value=\"NE\">Nebraska</option><option value=\"NV\">Nevada</option><option value=\"NH\">New Hampshire</option><option value=\"NJ\">New Jersey</option><option value=\"NM\">New Mexico</option><option value=\"NY\">New York</option><option value=\"NC\">North Carolina</option><option value=\"ND\">North Dakota</option><option value=\"OH\">Ohio</option><option value=\"OK\">Oklahoma</option><option value=\"OR\">Orego</option><option value=\"PA\">Pennsylvania</option><option value=\"RI\">Rhode Island</option><option value=\"SC\">South Carolina</option><option value=\"SD\">South Dakota</option><option value=\"TN\">Tennessee</option><option value=\"TX\">Texas</option><option value=\"UT\">Utah</option><option value=\"VT\">Vermont</option><option value=\"VA\">Virginia</option><option value=\"WA\">Washington</option><option value=\"WV\">West Virginia</option><option value=\"WI\">Wisconsin</option><option value=\"WY\">Wyoming</option></select>");
      var removeButton = $("<input type=\"button\" class=\"remove\" value=\"Remove\" />");
      removeButton.click(function() {
          $(this).parent().remove();
      });
      
      fieldWrapper.append(fMainType);
      fieldWrapper.append(fVersion);
      fieldWrapper.append(fType);
      fieldWrapper.append(fName);
      fieldWrapper.append(removeButton);
      $("#autointelstate").append(fieldWrapper); 

    });

    reset_alllevel();
    $(".productselect").bind("change", function () {
        reset_alllevel();
        if ($(".productselect  option:selected").text().toLowerCase() == "payorintel" ) {
            $("#type").show();
            $("#subtype").show();
            $("#file").show();
            $("#submitbutton").show();
        } else if ( $(".productselect  option:selected").text().toLowerCase() == "autointel" ) {
            $("#type").show();
            $("#file").show();
            $("#autointelstate").show();
            $("#submitbutton").show();

        } else if($(".productselect  option:selected").text().toLowerCase() == "charity" ) {
            $("#score_charity").show();
            $("#file").show();
            $("#ca_part").show();
            $("#submitbutton").show();
        } else if( $(".productselect  option:selected").text().toLowerCase() == "payment") {
            $("#score_payment").show();
            $("#file").show();
            $("#ca_part").show();
            $("#submitbutton").show();
        } else if( $(".productselect  option:selected").text().toLowerCase() == "payment and charity") {
            $("#score_payment").show();
            $("#score_charity").show();
            $("#file").show();
            $("#ca_part").show();
            $("#submitbutton").show();
        }
    });

    $("#subtype").bind("change", function () {
        reset_sublevel();
        if ($("#type option:selected").text().toLowerCase() == "per hit" && $("#subtype option:selected").text().toLowerCase() == "global") {
            $("#perhitglobal").show();
        } else if($("#type option:selected").text().toLowerCase() == "per hit" && $("#subtype option:selected").text().toLowerCase() == "per payor" ) {
            $("#perhitperpayor").show();
        } else if($("#type option:selected").text().toLowerCase() == "contingency"  && $("#subtype option:selected").text().toLowerCase() == "per payor") {
            $("#contingencyperpayor").show();
        } else if($("#type option:selected").text().toLowerCase() == "contingency"  && $("#subtype option:selected").text().toLowerCase() == "global") {
            $("#contingencyglobal").show();
        } else {
          return;
        }
        $("#file").show();
    });

     $("#type").bind("change", function () {
        reset_sublevel();
        if ($(".productselect  option:selected").text().toLowerCase() == "payorintel" ) {  
          if ($("#type option:selected").text().toLowerCase() == "per hit" && $("#subtype option:selected").text().toLowerCase() == "global") {
            $("#perhitglobal").show();
          } else if($("#type option:selected").text().toLowerCase() == "per hit" && $("#subtype option:selected").text().toLowerCase() == "per payor" ) {
              $("#perhitperpayor").show();
          } else if($("#type option:selected").text().toLowerCase() == "contingency"  && $("#subtype option:selected").text().toLowerCase() == "per payor") {
              $("#contingencyperpayor").show();
          } else if($("#type option:selected").text().toLowerCase() == "contingency"  && $("#subtype option:selected").text().toLowerCase() == "global") {
              $("#contingencyglobal").show();
          } else {
            return;
          }
        } else if ( $(".productselect  option:selected").text().toLowerCase() == "autointel") {
                $("#autointelstate").empty();
                $("#autointel").show();                
        } 
        
        $("#file").show();
    });

     $('#casign').click(function(){
      $("#cadate").slideToggle();
    });

  });

</script>